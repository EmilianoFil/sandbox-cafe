<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow">
  <title>Gestión de Usuarios</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/admin.css">
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Syncopate&display=swap" rel="stylesheet">
  <script type="module" src="js/firebase-auth.js"></script>
</head>
<body>
  <div class="menu-style">
    <nav class="menu-hamburguesa">
      <input type="checkbox" id="menu-toggle">
      <label for="menu-toggle" class="menu-icon">☰</label>
      <ul class="menu-links" id="menuLinks">
        <li><a href="admin.html">Volver</a></li>
      </ul>
    </nav>
    <div class="info-usuario">
      Usuario logueado: <span id="usuarioLogueado">-</span>
    </div>

    <h1>Gestión de Usuarios</h1>
    <form id="form-usuario" class="tarjeta-fidelidad">
      <input type="email" id="email" placeholder="Email" required />
      <input type="text" id="nombre" placeholder="Nombre" required />
      <select id="rol">
        <option value="empleado">Empleado</option>
        <option value="encargado">Encargado</option>
        <option value="duenio">Dueño</option>
        <option value="dev">Dev</option>
      </select>
      <button type="submit">Guardar</button>
    </form>

    <section class="tarjeta-fidelidad" style="margin-top: 20px;">
      <h2>Usuarios Registrados</h2>
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Nombre</th>
            <th>Rol</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="lista-usuarios">
          <!-- Usuarios cargados dinámicamente -->
        </tbody>
      </table>
    </section>

    <div class="logout" style="margin-top: 40px;">
      <a href="#" onclick="cerrarSesion()" class="cerrar">Cerrar sesión</a>
    </div>
  </div>

  <div id="sesion-expirada">
    <p>Sesión expirada</p>
    <a href="login.html">Volver a ingresar</a>
  </div>

  <script type="module">
    import { auth, signOut, onAuthStateChanged } from './js/firebase-auth.js';
    import { doc, getDoc, getFirestore } from 'https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js';
    const db = getFirestore();

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
      } else {
        const ref = doc(db, "admin", user.uid);
        const snap = await getDoc(ref);
        const nombre = snap.exists() ? (snap.data().nombre || user.email) : user.email;
        document.getElementById("usuarioLogueado").innerText = nombre;
      }
    });

    window.cerrarSesion = async function () {
      await signOut(auth);
      localStorage.clear();
      window.location.href = "login.html";
    };
  </script>

  <script type="module">
  async function cargarUsuarios() {
    try {
      const response = await fetch('https://us-central1-sandbox-cafe-emilianofil.cloudfunctions.net/api', {
        method: 'GET',
        mode: 'cors'
      });
      if (!response.ok) throw new Error('Error al obtener usuarios');
      const usuarios = await response.json();

      const tbody = document.getElementById("lista-usuarios");
      tbody.innerHTML = "";

      usuarios.forEach(usuario => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${usuario.email}</td>
          <td>${usuario.nombre || "-"}</td>
          <td>${usuario.rol || "empleado"}</td>
          <td><!-- Acciones futuras --></td>
        `;
        tbody.appendChild(tr);
      });
    } catch (error) {
      console.error("Error cargando usuarios:", error);
    }
  }

  cargarUsuarios();
</script>
</body>
</html>